<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông tin truy cập</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin-top: 20px;
        }
        tr {
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        tr:hover {
            background: #e9ecef;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border: none;
        }
        th {
            color: #6c757d;
            font-weight: 500;
            width: 30%;
        }
        td {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .icon {
            color: #007bff;
            margin-right: 10px;
            width: 20px;
        }
        h2 {
            color: #343a40;
            margin-bottom: 30px;
            font-weight: 600;
            text-align: center;
        }
        .loading {
            color: #6c757d;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            font-style: italic;
        }
        .browser-info {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        .browser-info .icon {
            width: 20px;
            margin-right: 10px;
            text-align: center;
        }
        .browser-info span {
            flex: 1;
        }
        .section-title {
            font-weight: 600;
            color: #007bff;
            margin-top: 10px;
            padding: 5px 0;
            border-bottom: 2px solid #e9ecef;
        }
        .browser-info {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .browser-info:hover {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2><i class="fas fa-globe icon"></i>Thông tin truy cập</h2>
        <table>
            <tr>
                <th><i class="fas fa-network-wired icon"></i>Địa chỉ IP</th>
                <td id="ip" class="loading">Đang tải...</td>
            </tr>
            <tr>
                <th><i class="fas fa-flag icon"></i>Quốc gia</th>
                <td id="country" class="loading">Đang tải...</td>
            </tr>
            <tr>
                <th><i class="fas fa-city icon"></i>Thành phố</th>
                <td id="city" class="loading">Đang tải...</td>
            </tr>
            <tr>
                <th><i class="fas fa-building icon"></i>Nhà mạng</th>
                <td id="isp" class="loading">Đang tải...</td>
            </tr>
            <tr>
                <th><i class="fas fa-browser icon"></i>Trình duyệt</th>
                <td id="browser"></td>
            </tr>
        </table>
    </div>
    
    <script>
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            let browserInfo = {
                name: "Không xác định",
                engine: "Không xác định",
                platform: navigator.platform,
                isWebView: false,
                language: navigator.language || navigator.userLanguage,
                cookieEnabled: navigator.cookieEnabled,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                colorDepth: window.screen.colorDepth,
                devicePixelRatio: window.devicePixelRatio,
                connection: navigator.connection ? {
                    type: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : null,
                memory: navigator.deviceMemory ? `${navigator.deviceMemory} GB` : "Không có thông tin",
                cores: navigator.hardwareConcurrency || "Không có thông tin",
                touchScreen: navigator.maxTouchPoints > 0,
                battery: null,
                online: navigator.onLine
            };

            // Kiểm tra thông tin pin
            if (navigator.getBattery) {
                navigator.getBattery().then(battery => {
                    browserInfo.battery = {
                        level: Math.round(battery.level * 100),
                        charging: battery.charging
                    };
                    updateBatteryInfo();
                });
            }

            // Phát hiện WebView
            if (ua.includes("wv") || ua.includes("WebView")) {
                browserInfo.isWebView = true;
            }

            // Phát hiện Engine
            if (window.chrome) {
                browserInfo.engine = "Blink (Chrome Engine)";
            } else if ('WebKitAppearance' in document.documentElement.style) {
                browserInfo.engine = "WebKit";
            } else if ('MozAppearance' in document.documentElement.style) {
                browserInfo.engine = "Gecko (Firefox Engine)";
            }

            // Phát hiện trình duyệt cụ thể
            if (ua.match(/edg/i)) {
                browserInfo.name = "Microsoft Edge";
            } else if (ua.match(/opr\//i) || ua.match(/opera/i)) {
                browserInfo.name = "Opera";
            } else if (ua.match(/chrome|chromium|crios/i)) {
                if (ua.match(/edg/i)) {
                    browserInfo.name = "Microsoft Edge";
                } else {
                    browserInfo.name = "Google Chrome";
                }
            } else if (ua.match(/firefox|fxios/i)) {
                browserInfo.name = "Mozilla Firefox";
            } else if (ua.match(/safari/i)) {
                browserInfo.name = "Safari";
            }

            // Phát hiện ứng dụng đặc biệt
            if (ua.match(/electron/i)) {
                browserInfo.name += " (Electron App)";
            } else if (ua.match(/mobile/i)) {
                if (ua.match(/instagram/i)) {
                    browserInfo.name = "Instagram In-App Browser";
                } else if (ua.match(/fbav|fban/i)) {
                    browserInfo.name = "Facebook In-App Browser";
                } else if (ua.match(/line/i)) {
                    browserInfo.name = "LINE In-App Browser";
                }
            }

            const getBrowserIcon = (browserName) => {
                if (browserName.includes("Chrome")) return "fa-chrome";
                if (browserName.includes("Firefox")) return "fa-firefox-browser";
                if (browserName.includes("Edge")) return "fa-edge";
                if (browserName.includes("Safari")) return "fa-safari";
                if (browserName.includes("Opera")) return "fa-opera";
                if (browserName.includes("Instagram")) return "fa-instagram";
                if (browserName.includes("Facebook")) return "fa-facebook";
                if (browserName.includes("LINE")) return "fa-line";
                return "fa-globe";
            };

            const getEngineIcon = (engineName) => {
                if (engineName.includes("Blink")) return "fa-chrome";
                if (engineName.includes("WebKit")) return "fa-safari";
                if (engineName.includes("Gecko")) return "fa-firefox-browser";
                return "fa-microchip";
            };

            const getPlatformIcon = (platform) => {
                if (platform.includes("Win")) return "fa-windows";
                if (platform.includes("Mac")) return "fa-apple";
                if (platform.includes("Linux")) return "fa-linux";
                if (platform.includes("Android")) return "fa-android";
                if (platform.includes("iPhone") || platform.includes("iPad")) return "fa-apple";
                return "fa-desktop";
            };

            const browserElement = document.getElementById('browser');
            function updateBatteryInfo() {
                browserElement.innerHTML = `
                    <div style="display: grid; gap: 10px;">
                        <div class="section-title">Thông tin trình duyệt</div>
                        <div class="browser-info">
                            <i class="fab ${getBrowserIcon(browserInfo.name)} icon"></i>
                            <span>Trình duyệt: ${browserInfo.name}</span>
                        </div>
                        <div class="browser-info">
                            <i class="fas ${getEngineIcon(browserInfo.engine)} icon"></i>
                            <span>Engine: ${browserInfo.engine}</span>
                        </div>
                        <div class="browser-info">
                            <i class="fas fa-language icon"></i>
                            <span>Ngôn ngữ: ${browserInfo.language}</span>
                        </div>
                        <div class="browser-info">
                            <i class="fas fa-cookie icon"></i>
                            <span>Cookie: ${browserInfo.cookieEnabled ? 'Được bật' : 'Bị tắt'}</span>
                        </div>

                        <div class="section-title">Thông tin thiết bị</div>
                        <div class="browser-info">
                            <i class="fab ${getPlatformIcon(browserInfo.platform)} icon"></i>
                            <span>Nền tảng: ${browserInfo.platform}</span>
                        </div>
                        <div class="browser-info">
                            <i class="fas fa-microchip icon"></i>
                            <span>CPU Cores: ${browserInfo.cores}</span>
                        </div>
                        <div class="browser-info">
                            <i class="fas fa-memory icon"></i>
                            <span>Bộ nhớ: ${browserInfo.memory}</span>
                        </div>
                        <div class="browser-info">
                            <i class="fas fa-desktop icon"></i>
                            <span>Độ phân giải: ${browserInfo.screenResolution} (${browserInfo.colorDepth}-bit)</span>
                        </div>
                        <div class="browser-info">
                            <i class="fas fa-mobile-alt icon"></i>
                            <span>Màn hình cảm ứng: ${browserInfo.touchScreen ? 'Có' : 'Không'}</span>
                        </div>

                        <div class="section-title">Thông tin kết nối</div>
                        <div class="browser-info">
                            <i class="fas fa-wifi icon"></i>
                            <span>Trạng thái: ${browserInfo.online ? 'Đang kết nối' : 'Không có kết nối'}</span>
                        </div>
                        ${browserInfo.connection ? `
                        <div class="browser-info">
                            <i class="fas fa-tachometer-alt icon"></i>
                            <span>Loại kết nối: ${browserInfo.connection.type}</span>
                        </div>
                        <div class="browser-info">
                            <i class="fas fa-download icon"></i>
                            <span>Tốc độ: ${browserInfo.connection.downlink} Mbps</span>
                        </div>
                        ` : ''}
                        ${browserInfo.battery ? `
                        <div class="browser-info">
                            <i class="fas ${browserInfo.battery.charging ? 'fa-plug' : 'fa-battery-half'} icon"></i>
                            <span>Pin: ${browserInfo.battery.level}% ${browserInfo.battery.charging ? '(Đang sạc)' : ''}</span>
                        </div>
                        ` : ''}

                        <div class="section-title">Thông tin khác</div>
                        ${browserInfo.isWebView ? `
                        <div class="browser-info">
                            <i class="fas fa-mobile-alt icon"></i>
                            <span>Đang chạy trong WebView</span>
                        </div>
                        ` : ''}
                        <div class="browser-info" style="font-size: 0.8em; color: #666;">
                            <i class="fas fa-info-circle icon"></i>
                            <span>User Agent: ${ua}</span>
                        </div>
                    </div>
                `;
            }
            updateBatteryInfo();
        }

        async function getIPInfo() {
            const apis = [
                {
                    url: 'https://api.ipify.org?format=json',
                    transform: async (data) => {
                        const detailResponse = await fetch(`https://ipapi.co/${data.ip}/json/`);
                        const detailData = await detailResponse.json();
                        return {
                            ip: data.ip,
                            country: detailData.country_name,
                            city: detailData.city,
                            isp: detailData.org
                        };
                    }
                },
                {
                    url: 'https://api64.ipify.org?format=json',
                    transform: async (data) => {
                        const detailResponse = await fetch(`https://ip-api.com/json/${data.ip}?fields=status,message,country,city,isp`);
                        const detailData = await detailResponse.json();
                        return {
                            ip: data.ip,
                            country: detailData.country,
                            city: detailData.city,
                            isp: detailData.isp
                        };
                    }
                },
                {
                    url: 'https://api.db-ip.com/v2/free/self',
                    transform: (data) => ({
                        ip: data.ipAddress,
                        country: data.countryName,
                        city: data.city,
                        isp: data.ipAddress
                    })
                }
            ];

            const setLoading = (elements) => {
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    element.textContent = 'Đang tải...';
                    element.classList.add('loading');
                    element.classList.remove('error');
                });
            };

            const setError = (message, elements) => {
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    element.textContent = message;
                    element.classList.remove('loading');
                    element.classList.add('error');
                });
            };

            const elements = ['ip', 'country', 'city', 'isp'];
            let lastError = null;
            setLoading(elements);

            for (const api of apis) {
                try {
                    console.log('Đang thử với API:', api.url);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // timeout 5 giây

                    const response = await fetch(api.url, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.reason || 'API trả về lỗi');
                    }

                    const transformedData = await api.transform(data);
                    
                    for (const [id, value] of Object.entries(transformedData)) {
                        const element = document.getElementById(id);
                        element.textContent = value || 'Không có thông tin';
                        element.classList.remove('loading', 'error');
                    }

                    console.log('Lấy thông tin IP thành công từ:', api.url);
                    return;
                } catch (error) {
                    console.error('Lỗi với API:', api.url, error);
                    lastError = error;
                    continue;
                }
            }

            // Nếu tất cả API đều thất bại
            let errorMessage = 'Không thể lấy thông tin IP. ';
            if (!navigator.onLine) {
                errorMessage = 'Vui lòng kiểm tra kết nối internet của bạn';
            } else if (lastError) {
                if (lastError.name === 'AbortError') {
                    errorMessage += 'Kết nối quá chậm, vui lòng thử lại.';
                } else if (lastError.message.includes('CORS')) {
                    errorMessage += 'Lỗi CORS - Vui lòng thử lại sau.';
                } else {
                    errorMessage += 'Các API không phản hồi, vui lòng thử lại sau.';
                }
            }
            setError(errorMessage, elements);
        }

        getIPInfo();
        getBrowserInfo();
    </script>
</body>
</html>
